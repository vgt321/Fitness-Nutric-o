<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro - Fitness NutricÃ£o</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <!-- CABEÃ‡ALHO -->
    <header>
        <div class="container">
            <h1>ğŸ’° Controle Financeiro</h1>
            <p>Gerencie pagamentos e relatÃ³rios financeiros</p>
        </div>
    </header>

    <!-- MENU DE NAVEGAÃ‡ÃƒO -->
    <nav>
        <div class="container">
            <a href="../index.html" class="btn-nav">ğŸ  InÃ­cio</a>
            <a href="clientes.html" class="btn-nav">ğŸ‘¥ Clientes</a>
            <a href="avaliacoes.html" class="btn-nav">ğŸ“Š AvaliaÃ§Ãµes</a>
            <a href="planos.html" class="btn-nav">ğŸ“‹ Planos</a>
            <a href="consultas.html" class="btn-nav">ğŸ“… Consultas</a>
            <a href="financeiro.html" class="btn-nav active">ğŸ’° Financeiro</a>
        </div>
    </nav>

    <!-- CONTEÃšDO PRINCIPAL -->
    <main class="container">
        <!-- RELATÃ“RIOS RESUMIDOS -->
        <div class="cards-grid" style="margin-bottom: 30px;">
            <div class="card">
                <div class="card-icon">ğŸ’µ</div>
                <h3>Total Recebido (MÃªs)</h3>
                <p style="font-size: 2em; color: #28a745; font-weight: bold; margin: 10px 0;">
                    R$ <span id="totalRecebido">0,00</span>
                </p>
                <p style="color: #666; font-size: 0.9em;">Pagamentos confirmados</p>
            </div>

            <div class="card">
                <div class="card-icon">â³</div>
                <h3>Total Pendente</h3>
                <p style="font-size: 2em; color: #ffc107; font-weight: bold; margin: 10px 0;">
                    R$ <span id="totalPendente">0,00</span>
                </p>
                <p style="color: #666; font-size: 0.9em;">Aguardando pagamento</p>
            </div>

            <div class="card">
                <div class="card-icon">ğŸš¨</div>
                <h3>Total Atrasado</h3>
                <p style="font-size: 2em; color: #dc3545; font-weight: bold; margin: 10px 0;">
                    R$ <span id="totalAtrasado">0,00</span>
                </p>
                <p style="color: #666; font-size: 0.9em;">Pagamentos vencidos</p>
            </div>

            <div class="card card-stats">
                <div class="card-icon">ğŸ“Š</div>
                <h3>EstatÃ­sticas</h3>
                <div class="stats">
                    <p><strong id="totalPagamentos">0</strong> Pagamentos</p>
                    <p><strong id="clientesAtivos">0</strong> Clientes Ativos</p>
                    <p><strong id="clientesVIP">0</strong> Clientes VIP</p>
                </div>
            </div>
        </div>

        <!-- FORMULÃRIO DE PAGAMENTO -->
        <div class="form-box">
            <h2>ğŸ’³ Registrar Pagamento</h2>
            <form id="formPagamento">
                <div class="form-group">
                    <label for="clienteId">Selecione o Cliente *</label>
                    <select id="clienteId" required>
                        <option value="">Selecione um cliente...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipoServico">Tipo de ServiÃ§o *</label>
                    <select id="tipoServico" required>
                        <option value="">Selecione...</option>
                        <option value="Plano Mensal">ğŸ“‹ Plano Mensal</option>
                        <option value="Consulta Personal">ğŸ‹ï¸ Consulta Personal Trainer</option>
                        <option value="Consulta Nutricionista">ğŸ¥— Consulta Nutricionista</option>
                        <option value="AvaliaÃ§Ã£o FÃ­sica">ğŸ“Š AvaliaÃ§Ã£o FÃ­sica</option>
                        <option value="Plano VIP">â­ Plano VIP</option>
                        <option value="Outro">â• Outro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="valorPagamento">Valor (R$) *</label>
                    <input type="number" id="valorPagamento" step="0.01" required placeholder="Ex: 150.00">
                </div>

                <div class="form-group">
                    <label for="dataPagamento">Data do Pagamento *</label>
                    <input type="date" id="dataPagamento" required>
                </div>

                <div class="form-group">
                    <label for="dataVencimento">Data de Vencimento</label>
                    <input type="date" id="dataVencimento">
                </div>

                <div class="form-group">
                    <label for="metodoPagamento">MÃ©todo de Pagamento *</label>
                    <select id="metodoPagamento" required>
                        <option value="">Selecione...</option>
                        <option value="Dinheiro">ğŸ’µ Dinheiro</option>
                        <option value="CartÃ£o de CrÃ©dito">ğŸ’³ CartÃ£o de CrÃ©dito</option>
                        <option value="CartÃ£o de DÃ©bito">ğŸ’³ CartÃ£o de DÃ©bito</option>
                        <option value="PIX">ğŸ“± PIX</option>
                        <option value="TransferÃªncia">ğŸ¦ TransferÃªncia BancÃ¡ria</option>
                        <option value="Boleto">ğŸ“„ Boleto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="statusPagamento">Status do Pagamento *</label>
                    <select id="statusPagamento" required>
                        <option value="Pago">âœ… Pago</option>
                        <option value="Pendente">â³ Pendente</option>
                        <option value="Atrasado">ğŸš¨ Atrasado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="observacoes">ObservaÃ§Ãµes</label>
                    <textarea id="observacoes" placeholder="InformaÃ§Ãµes adicionais sobre o pagamento..."></textarea>
                </div>

                <button type="submit" class="btn-primary">ğŸ’¾ Salvar Pagamento</button>
                <button type="button" class="btn-secondary" onclick="limparFormulario()">ğŸ”„ Limpar</button>
            </form>
        </div>

        <!-- MENSAGEM -->
        <div id="mensagem" style="display: none;"></div>

        <!-- RELATÃ“RIO FINANCEIRO POR SERVIÃ‡O -->
        <div class="table-box" style="margin-bottom: 30px;">
            <h2>ğŸ“Š Receita por Tipo de ServiÃ§o</h2>
            <table id="tabelaReceita">
                <thead>
                    <tr>
                        <th>Tipo de ServiÃ§o</th>
                        <th>Quantidade</th>
                        <th>Receita Total</th>
                        <th>% do Total</th>
                    </tr>
                </thead>
                <tbody id="listaReceita">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999;">
                            Nenhum pagamento registrado
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- LISTA DE PAGAMENTOS -->
        <div class="table-box">
            <h2>ğŸ“‹ HistÃ³rico de Pagamentos</h2>
            <div style="margin-bottom: 15px;">
                <select id="filtroCliente" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-right: 10px;">
                    <option value="">ğŸ“Œ Todos os clientes</option>
                </select>
                <select id="filtroStatus" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-right: 10px;">
                    <option value="">ğŸ’³ Todos os status</option>
                    <option value="Pago">âœ… Pago</option>
                    <option value="Pendente">â³ Pendente</option>
                    <option value="Atrasado">ğŸš¨ Atrasado</option>
                </select>
                <select id="filtroServico" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-right: 10px;">
                    <option value="">ğŸ·ï¸ Todos os serviÃ§os</option>
                </select>
            </div>
            <table id="tabelaPagamentos">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>ServiÃ§o</th>
                        <th>Valor</th>
                        <th>Data Pagamento</th>
                        <th>MÃ©todo</th>
                        <th>Status</th>
                        <th>AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody id="listaPagamentos">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999;">
                            Nenhum pagamento registrado ainda
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- RODAPÃ‰ -->
    <footer>
        <div class="container">
            <p>&copy; 2024 Vida SaudÃ¡vel - Todos os direitos reservados</p>
        </div>
    </footer>

    <script>
        // CARREGAR PÃGINA
        document.addEventListener('DOMContentLoaded', function() {
            carregarClientesSelect();
            carregarPagamentos();
            calcularResumo();
            gerarRelatorioReceita();
            
            // Auto-completar data com hoje
            document.getElementById('dataPagamento').valueAsDate = new Date();
        });

        // CARREGAR CLIENTES NO SELECT
        function carregarClientesSelect() {
            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            const selectCliente = document.getElementById('clienteId');
            const filtroCliente = document.getElementById('filtroCliente');
            
            selectCliente.innerHTML = '<option value="">Selecione um cliente...</option>';
            filtroCliente.innerHTML = '<option value="">ğŸ“Œ Todos os clientes</option>';
            
            clientes.forEach(cliente => {
                const option1 = document.createElement('option');
                option1.value = cliente.id;
                option1.textContent = `${cliente.nome} - ${cliente.tipo}`;
                selectCliente.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = cliente.id;
                option2.textContent = cliente.nome;
                filtroCliente.appendChild(option2);
            });
        }

        // CARREGAR SERVIÃ‡OS NO FILTRO
        function carregarServicos() {
            const pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
            const servicos = [...new Set(pagamentos.map(p => p.tipoServico))];
            const filtroServico = document.getElementById('filtroServico');
            
            filtroServico.innerHTML = '<option value="">ğŸ·ï¸ Todos os serviÃ§os</option>';
            servicos.forEach(servico => {
                const option = document.createElement('option');
                option.value = servico;
                option.textContent = servico;
                filtroServico.appendChild(option);
            });
        }

        // SALVAR PAGAMENTO
        document.getElementById('formPagamento').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const clienteId = parseInt(document.getElementById('clienteId').value);
            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            const cliente = clientes.find(c => c.id === clienteId);
            
            if (!cliente) {
                mostrarMensagem('Cliente nÃ£o encontrado!', 'danger');
                return;
            }
            
            const pagamento = {
                id: Date.now(),
                clienteId: clienteId,
                clienteNome: cliente.nome,
                clienteTipo: cliente.tipo,
                tipoServico: document.getElementById('tipoServico').value,
                valorPagamento: parseFloat(document.getElementById('valorPagamento').value),
                dataPagamento: document.getElementById('dataPagamento').value,
                dataVencimento: document.getElementById('dataVencimento').value,
                metodoPagamento: document.getElementById('metodoPagamento').value,
                statusPagamento: document.getElementById('statusPagamento').value,
                observacoes: document.getElementById('observacoes').value,
                dataCadastro: new Date().toISOString()
            };
            
            let pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
            pagamentos.push(pagamento);
            localStorage.setItem('pagamentos', JSON.stringify(pagamentos));
            
            mostrarMensagem('Pagamento registrado com sucesso! âœ…', 'success');
            limparFormulario();
            carregarPagamentos();
            calcularResumo();
            gerarRelatorioReceita();
            carregarServicos();
        });

        // CALCULAR RESUMO
        function calcularResumo() {
            const pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
            const clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            // Filtrar pagamentos do mÃªs atual
            const pagamentosMes = pagamentos.filter(p => {
                const data = new Date(p.dataPagamento);
                return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
            });
            
            const totalRecebido = pagamentosMes
                .filter(p => p.statusPagamento === 'Pago')
                .reduce((sum, p) => sum + p.valorPagamento, 0);
            
            const totalPendente = pagamentos
                .filter(p => p.statusPagamento === 'Pendente')
                .reduce((sum, p) => sum + p.valorPagamento, 0);
            
            const totalAtrasado = pagamentos
                .filter(p => p.statusPagamento === 'Atrasado')
                .reduce((sum, p) => sum + p.valorPagamento, 0);
            
            document.getElementById('totalRecebido').textContent = totalRecebido.toFixed(2).replace('.', ',');
            document.getElementById('totalPendente').textContent = totalPendente.toFixed(2).replace('.', ',');
            document.getElementById('totalAtrasado').textContent = totalAtrasado.toFixed(2).replace('.', ',');
            
            document.getElementById('totalPagamentos').textContent = pagamentos.length;
            document.getElementById('clientesAtivos').textContent = clientes.length;
            document.getElementById('clientesVIP').textContent = clientes.filter(c => c.tipo === 'VIP').length;
        }

        // GERAR RELATÃ“RIO DE RECEITA POR SERVIÃ‡O
        function gerarRelatorioReceita() {
            const pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
            const pagamentosPagos = pagamentos.filter(p => p.statusPagamento === 'Pago');
            
            const receitaPorServico = {};
            let totalGeral = 0;
            
            pagamentosPagos.forEach(p => {
                if (!receitaPorServico[p.tipoServico]) {
                    receitaPorServico[p.tipoServico] = {
                        quantidade: 0,
                        total: 0
                    };
                }
                receitaPorServico[p.tipoServico].quantidade++;
                receitaPorServico[p.tipoServico].total += p.valorPagamento;
                totalGeral += p.valorPagamento;
            });
            
            const tbody = document.getElementById('listaReceita');
            
            if (Object.keys(receitaPorServico).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Nenhum pagamento registrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            Object.keys(receitaPorServico).forEach(servico => {
                const dados = receitaPorServico[servico];
                const percentual = ((dados.total / totalGeral) * 100).toFixed(1);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${servico}</strong></td>
                    <td>${dados.quantidade}</td>
                    <td style="color: #28a745; font-weight: bold;">R$ ${dados.total.toFixed(2).replace('.', ',')}</td>
                    <td>${percentual}%</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Adicionar linha de total
            const trTotal = document.createElement('tr');
            trTotal.style.backgroundColor = '#f0f0f0';
            trTotal.style.fontWeight = 'bold';
            trTotal.innerHTML = `
                <td>TOTAL</td>
                <td>${pagamentosPagos.length}</td>
                <td style="color: #28a745;">R$ ${totalGeral.toFixed(2).replace('.', ',')}</td>
                <td>100%</td>
            `;
            tbody.appendChild(trTotal);
        }

        // CARREGAR PAGAMENTOS
        function carregarPagamentos(filtroClienteId = null, filtroStatusVal = null, filtroServicoVal = null) {
            let pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
            
            // Aplicar filtros
            if (filtroClienteId) {
                pagamentos = pagamentos.filter(p => p.clienteId === parseInt(filtroClienteId));
            }
            if (filtroStatusVal) {
                pagamentos = pagamentos.filter(p => p.statusPagamento === filtroStatusVal);
            }
            if (filtroServicoVal) {
                pagamentos = pagamentos.filter(p => p.tipoServico === filtroServicoVal);
            }
            
            const tbody = document.getElementById('listaPagamentos');
            
            if (pagamentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Nenhum pagamento encontrado</td></tr>';
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            pagamentos.sort((a, b) => new Date(b.dataPagamento) - new Date(a.dataPagamento));
            
            tbody.innerHTML = '';
            
            pagamentos.forEach(pagamento => {
                const tr = document.createElement('tr');
                
                let badgeStatus = 'badge-success';
                if (pagamento.statusPagamento === 'Pendente') badgeStatus = 'badge-normal';
                if (pagamento.statusPagamento === 'Atrasado') badgeStatus = 'badge-danger';
                
                tr.innerHTML = `
                    <td>${pagamento.clienteNome}</td>
                    <td>${pagamento.tipoServico}</td>
                    <td style="color: #28a745; font-weight: bold;">R$ ${pagamento.valorPagamento.toFixed(2).replace('.', ',')}</td>
                    <td>${formatarData(pagamento.dataPagamento)}</td>
                    <td>${pagamento.metodoPagamento}</td>
                    <td><span class="badge ${badgeStatus}">${pagamento.statusPagamento}</span></td>
                    <td>
                        <button class="btn-primary" style="padding: 5px 10px; font-size: 0.9em; margin-right: 5px;" 
                                onclick="verDetalhes(${pagamento.id})">ğŸ‘ï¸ Ver</button>
                        <button class="btn-danger" style="padding: 5px 10px; font-size: 0.9em;" 
                                onclick="excluirPagamento(${pagamento.id})">ğŸ—‘ï¸ Excluir</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            carregarServicos();
        }

        // FILTROS
        document.getElementById('filtroCliente').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroServico').addEventListener('change', aplicarFiltros);

        function aplicarFiltros() {
            const clienteId = document.getElementById('filtroCliente').value;
            const status = document.getElementById('filtroStatus').value;
            const servico = document.getElementById('filtroServico').value;
            carregarPagamentos(clienteId || null, status || null, servico || null);
        }

        // EXCLUIR PAGAMENTO
        function excluirPagamento(id) {
            if (confirm('Tem certeza que deseja excluir este pagamento?')) {
                let pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
                pagamentos = pagamentos.filter(p => p.id !== id);
                localStorage.setItem('pagamentos', JSON.stringify(pagamentos));
                mostrarMensagem('Pagamento excluÃ­do com sucesso!', 'success');
                carregarPagamentos();
                calcularResumo();
                gerarRelatorioReceita();
            }
        }

        // VER DETALHES
        function verDetalhes(id) {
            const pagamentos = JSON.parse(localStorage.getItem('pagamentos')) || [];
            const pagamento = pagamentos.find(p => p.id === id);
            
            if (pagamento) {
                alert(`
ğŸ’° DETALHES DO PAGAMENTO

Cliente: ${pagamento.clienteNome} (${pagamento.clienteTipo})
ServiÃ§o: ${pagamento.tipoServico}
Valor: R$ ${pagamento.valorPagamento.toFixed(2).replace('.', ',')}
Data Pagamento: ${formatarData(pagamento.dataPagamento)}
Data Vencimento: ${pagamento.dataVencimento ? formatarData(pagamento.dataVencimento) : 'NÃ£o definida'}
MÃ©todo: ${pagamento.metodoPagamento}
Status: ${pagamento.statusPagamento}

ğŸ“ ObservaÃ§Ãµes: ${pagamento.observacoes || 'Nenhuma'}
                `);
            }
        }

        // LIMPAR FORMULÃRIO
        function limparFormulario() {
            document.getElementById('formPagamento').reset();
            document.getElementById('dataPagamento').valueAsDate = new Date();
        }

        // MOSTRAR MENSAGEM
        function mostrarMensagem(texto, tipo) {
            const div = document.getElementById('mensagem');
            div.className = tipo === 'success' ? 'alert alert-success' : 'alert alert-danger';
            div.textContent = texto;
            div.style.display = 'block';
            
            setTimeout(() => {
                div.style.display = 'none';
            }, 3000);
        }

        // FORMATAR DATA
        function formatarData(data) {
            const d = new Date(data + 'T00:00:00');
            return d.toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html>